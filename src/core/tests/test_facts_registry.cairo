use snforge_std::{declare, PreparedContract, deploy, start_prank, stop_prank};

use herodotus_eth_starknet::core::headers_store::{IHeadersStoreDispatcherTrait, IHeadersStoreDispatcher};
use herodotus_eth_starknet::core::evm_facts_registry::{IEVMFactsRegistryDispatcherTrait, IEVMFactsRegistryDispatcher, AccountField};
use starknet::ContractAddress;
use cairo_lib::utils::types::words64::Words64;
use cairo_lib::hashing::poseidon::{hash_words64, PoseidonHasher};
use cairo_lib::data_structures::mmr::{proof::Proof, peaks::Peaks};
use debug::PrintTrait;

const COMMITMENTS_INBOX_ADDRESS: felt252 = 0x123;
const TEST_MMR_ROOT: felt252 = 0x37a31db9c80c54ec632f04f7984155dc43591a3f8c891adfbf34e75331e0eec;
const TEST_MMR_SIZE: usize = 8;

fn helper_create_facts_registry(mmr_root: felt252, mmr_size: usize) -> (IEVMFactsRegistryDispatcher, ContractAddress) {
    let class_hash = declare('HeadersStore');
    let prepared = PreparedContract {
        class_hash: class_hash, constructor_calldata: @array![COMMITMENTS_INBOX_ADDRESS]
    };
    let contract_address = deploy(prepared).unwrap();
    let mut headers_store = IHeadersStoreDispatcher { contract_address };
    start_prank(contract_address, COMMITMENTS_INBOX_ADDRESS.try_into().unwrap());
    headers_store.create_branch_from_message(mmr_root, mmr_size, 0);
    stop_prank(contract_address);

    let class_hash = declare('EVMFactsRegistry');
    let prepared = PreparedContract {
        class_hash: class_hash, constructor_calldata: @array![contract_address.into()]
    };
    let contract_address = deploy(prepared).unwrap();
    (IEVMFactsRegistryDispatcher { contract_address }, contract_address)
}

#[test]
fn test_prove_account() {
    let (dispatcher, contract_address) = helper_create_facts_registry(TEST_MMR_ROOT, TEST_MMR_SIZE);

    // Proof for block 17000000
    let block_header_rlp = *helper_get_headers_rlp().at(0);
    let (mmr_proofs, peaks) = helper_get_mmr_proofs_peaks();
    let mmr_proof = *mmr_proofs.at(0);
    let fields = array![AccountField::Nonce, AccountField::Balance, AccountField::StorageHash, AccountField::CodeHash].span();
    dispatcher.prove_account(
        fields,
        block_header_rlp,
        0,
        array![].span(),
        2,
        peaks,
        mmr_proof,
        1,
        TEST_MMR_SIZE
    );
}

// Returns (proofs, peaks)
fn helper_get_mmr_proofs_peaks() -> (Span<Proof>, Peaks) {
    let headers = helper_get_headers_rlp();

    let l1 = 0x02241b3b7f1c4b9cf63e670785891de91f7237b1388f6635c1898ae397ad32dd;
    let l2 = hash_words64(*headers.at(0));
    let l3 = hash_words64(*headers.at(1));
    let l4 = hash_words64(*headers.at(2));
    let l5 = hash_words64(*headers.at(3));

    let peaks = array![
        PoseidonHasher::hash_double(
            PoseidonHasher::hash_double(l1, l2),
            PoseidonHasher::hash_double(l3, l4),
        ),
        l5
    ].span();

    (
        array![
            array![l1, PoseidonHasher::hash_double(l3, l4)].span(),
            array![l4, PoseidonHasher::hash_double(l1, l2)].span(),
            array![l3, PoseidonHasher::hash_double(l1, l2)].span(),
            array![].span()
        ].span(),
        peaks
    )
}

fn helper_get_headers_rlp() -> Span<Words64> {
    array![
        array![
            2263451220831175417,
            15475506108952879400,
            741690966216059028,
            13724127879293809526,
            5605888210103258221,
            13080049234815213288,
            4977272650390615655,
            4801382644103943195,
            822351442115576061,
            2060919963544886938,
            18065096119526433143,
            1608533759003496649,
            16489482639633695118,
            7025941497850136839,
            10591609375142486485,
            7220336757408602667,
            7856157561857638375,
            3853215147490336009,
            9070333417946327719,
            9150428924427655983,
            4661516135849121303,
            13467930351579739758,
            11044089176353269841,
            484970083255961,
            1456070127597430016,
            6996368964054954260,
            6125042939451209992,
            13382169361900390758,
            13384706961269000216,
            726594207542745875,
            155868532616267650,
            4408436971440116262,
            3227122037203945572,
            8070679583062700783,
            10955358009385170327,
            5350963046420058626,
            108160275332743715,
            6381397266628877336,
            10864858612374694,
            3747198369819467930,
            1158024666376900867,
            14346358011940197873,
            5477400452999241732,
            2501491483916515854,
            5366374862300466635,
            1192345635063386634,
            219182559240669484,
            9439546545580609842,
            1306354196916066381,
            11323468202912547128,
            15019515907020639297,
            5108293730157035012,
            9271082673976782882,
            5873126165013603462,
            8683586642608403599,
            7970228417676569,
            109283097845007488,
            9532652062815339465,
            2340009848045711460,
            8243105109760107072,
            17981836061268408368,
            7350476381845388023,
            6675110943001960198,
            5980065904163247402,
            150047286339368,
            325666548054228992,
            3786134474
        ]
            .span(),
        array![
            18073948714761847545,
            3290041491040724544,
            6598842851249156943,
            5529524783226291947,
            5605888210011765240,
            13080049234815213288,
            4977272650390615655,
            4801382644103943195,
            6193175472731603197,
            7086963355284609558,
            4995438275794032993,
            16956357881389657030,
            15613776393908769712,
            2193139528487071678,
            10804628434238642549,
            11142474787304836249,
            8300668493757212547,
            691775098901035867,
            1575644320975544375,
            4194326385868609400,
            4505473742391860683,
            12494856608087585096,
            6041528240182399639,
            485361786249898,
            464653979515988252,
            3541254846823932931,
            2352324107368962624,
            3891699727207523185,
            318242716413069334,
            11269660922827772386,
            16222810945268829475,
            1540578610629379349,
            8766291876504540681,
            8378491135147941611,
            15085376041798092450,
            9557017229828589058,
            2380735362467103630,
            6380566034511823220,
            2315045011511580928,
            290562627456467178,
            5188203018714352673,
            7066178713878904833,
            6351221582347420417,
            4690525538907068711,
            1756738133233600683,
            4656339391256003887,
            9478355114445065478,
            6958207667992092688,
            1298202110618166121,
            3490973676261181968,
            1171440115169305832,
            1182196112113288310,
            5531344054721352480,
            331926494334000397,
            15889399050641101526,
            1215186644830539848,
            109281998333379712,
            9521983613160178633,
            6320697073782894692,
            15975942949964087686,
            11429022381281133393,
            3156334603524254354,
            38519522890963463,
            9583660007044415488,
            730522711556
        ]
            .span(),
        array![
            16258094403813245689,
            8848141150820070407,
            9389337065954772067,
            6661813387766626173,
            5605888210970854734,
            13080049234815213288,
            4977272650390615655,
            4801382644103943195,
            822351442115576061,
            2060919963544886938,
            18065096119526433143,
            14135443637078626505,
            1149132355277286562,
            17075401624164885194,
            2224691342506516857,
            15861493743569776204,
            5015209523127625563,
            7886281485269689195,
            3201513657845167049,
            13445339048197784617,
            2722472119466823668,
            16348681903395167598,
            3153165077052095424,
            485300223273810,
            9834119466139625891,
            3533162832434418011,
            8233799357976852748,
            2771626766815771043,
            2329311774773823634,
            18161797320538812599,
            6321723364700918038,
            63524636975373447,
            7613640039527949060,
            2888100744547973739,
            10389346990891731616,
            2911820121303234560,
            14107800826278324478,
            5415655881191781464,
            1659207482701845004,
            9590643411577537759,
            469130880880984840,
            508909024075604404,
            7670166929783101495,
            7393490203459105868,
            3779684785234237594,
            13209357100645878666,
            264205773068502156,
            5929139682183867948,
            6918200283421216843,
            8887434976564905797,
            4425384324557026668,
            2657246422577133158,
            14240392002589373476,
            113823169938948,
            13952776587774279593,
            809656802443033230,
            109280898821751936,
            7500671518624498633,
            8458476963213894788,
            3924940343138872425,
            15613244428192161849,
            12991289672117631062,
            9087286043836762247,
            1077017187705520547,
            8977572,
            14581652858232373248,
            176
        ]
            .span(),
        array![
            18117585367741825785,
            11397625231657444299,
            13020100591073269189,
            18063699384525308064,
            5605888213284998782,
            13080049234815213288,
            4977272650390615655,
            4801382644103943195,
            2492061003963187453,
            15942085690261344290,
            5461852400203701304,
            956453846532548015,
            15906639059275075554,
            4531630737325424748,
            6736363734040833168,
            1446842186843128587,
            17715095491322047417,
            14688583986064528878,
            12125714989419609197,
            6124987441207038151,
            12310790503049931683,
            16441258639057996025,
            10986973253936343588,
            485368778672626,
            9519748492945323136,
            13188229551610669264,
            8126548237727481366,
            10535488506593274675,
            2819363699747669341,
            2932751463835833597,
            11740392584503478567,
            15202868471241462382,
            12680104983162081529,
            4169800423664923560,
            13122015778666320268,
            3656107654205198376,
            74808653070094231,
            5308971143734792580,
            3226401757423811040,
            7230628839993774042,
            3492934170351703975,
            5701625586977652771,
            8661157851087331334,
            15041871135591427148,
            4140641292659165375,
            7700685200877656852,
            9733868595213004673,
            8201196711109809186,
            4813828554610839641,
            17346816928903627276,
            5920873595315875274,
            4945096467382339067,
            9736195843772560018,
            5022361903244281670,
            18019021205241238728,
            8285664062163439164,
            109279799310124160,
            9576733936399205321,
            7018123964667736164,
            7236274654161298806,
            2064673519172742958,
            9433434497394490918,
            613123056794871754,
            12438023933322756306,
            149833700565390,
            325666548054228992,
            2995362435
        ]
            .span(),
    ]
        .span()
}
